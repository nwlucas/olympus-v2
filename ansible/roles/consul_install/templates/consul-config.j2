{%- if consul_listener_interface == "default" %}
  {% set consul_listener_address =  ansible_facts['default_ipv4']['address'] %}
{% elif consul_listener_interface == "all" %}
  {% set consul_listener_address =  "0.0.0.0" -%}
{% else %}
  {% set consul_listener_address =  ansible_facts[consul_listener_interface]['ipv4']['address'] -%}
{% endif %}

server                  = true
bootstrap_expect        = {{ groups['consul_servers']|length }}
node_name               = "{{ inventory_hostname }}"
disable_update_check    = true
verify_incoming         = true
verify_outgoing         = true
verify_server_hostname  = true

bind_addr           = "{{consul_listener_address}}"
client_addr         = "{{consul_listener_address}}"
advertise_addr_ipv4 = "{{consul_listener_address}}"

{% if consul_enable_syslog %}
enable_syslog = true
{% endif %}
{% if consul_enable_ui %}
ui_config {
  enabled = true
}
{% endif %}
log_level     = "{{ consul_log_level }}"
datacenter    = "{{ consul_datacenter }}"
data_dir      = "{{ consul_config_path | dirname}}/data"
domain        = "{{ consul_domain }}"

encrypt  = "{{ consul_encrypt_token }}"
ca_file   = "{{ consul_config_path | dirname }}/certs/cluster/"
cert_file = ""
key_file  = ""

auto_encrypt {
  allow_tls = true
}

connect {
  enabled = true
}

ports {
  grpc  = {{ consul_ports['grpc'] }}
  http  = {{ consul_ports['http'] }}
  https = {{ consul_ports['https'] }}
  dns   = {{ consul_ports['dns'] }}
}
